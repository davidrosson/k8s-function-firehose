# Kubernetes Function Firehose üë®‚Äçüöí

A ZSH script for dynamically generating a bunch of shell functions from a map of Kubernetes resource types and
associated shortnames. Each generated function is named for a Kubernetes resource shortname, and when executed, enables
vastly simplified querying of most Kubernetes resources (via `get` and `describe`) and interaction with Kubernetes Pods
(via `logs` and `exec`).

## Introduction

The shell functions generated by the Kubernetes Function Firehose script improve the speed and simplicity of accessing
Kubernetes resource details and interacting with Pods.

### Without Kubernetes Function Firehose

A typical workflow for displaying the details of a specific Kubernetes resource or interacting with a Pod requires
typing long commands and copying/pasting resource names, as shown in the following scenario:

1. Execute:

       kubectl get pod

1. Look through the output:

       NAME                                        READY   STATUS      RESTARTS   AGE
       my-stateful-set-sandbox-0                   1/1     Running     0          94d
       my-scheduled-job-sandbox-1715615200-c64dc   0/1     Completed   0          2d6h
       my-scheduled-job-sandbox-1715701600-jdfv7   0/1     Completed   0          30h
       my-scheduled-job-sandbox-1715788000-fswjd   0/1     Completed   0          6h46m
       demo-java-app-sandbox-6755c8dfd7-8wkx2      1/1     Running     0          4h11m
       demo-java-app-sandbox-6755c8dfd7-dxw76      1/1     Running     0          4h11m
       demo-nodejs-app-sandbox-d45f7b8b-8bhwm      2/2     Running     0          5d2h
       demo-nodejs-app-sandbox-d45f7b8b-c4vjz      2/2     Running     0          5d2h
       traefik-sandbox-7c5f6de147-5q24z            1/1     Running     0          61d
       traefik-sandbox-7c5f6de147-3s2k8            1/1     Running     0          61d

1. Get the YAML configuration of the resource, by typing or copying/pasting its name into a new command:

       kubectl get pod demo-java-app-sandbox-6755c8dfd7-8wkx2 -o yaml | less

1. Describe the details of the resource, by typing or copying/pasting its name into a new command:

       kubectl get pod demo-java-app-sandbox-6755c8dfd7-8wkx2 -o yaml | less

1. Follow the logs of the resource (if it's a Pod), by typing or copying/pasting its name into a new command:

       kubectl logs -f demo-java-app-sandbox-6755c8dfd7-8wkx2

1. Execute a command (e.g. `env`) on the resource (if it's a Pod), by typing or copying/pasting its name into a new
   command:

       kubectl exec -it demo-java-app-sandbox-6755c8dfd7-8wkx2 -- env

### Using Kubernetes Function Firehose

When using the shell functions generated by the Kubernetes Function Firehose script, the workflow for displaying the
details of a specific Kubernetes resource or interacting with a Pod is much simpler, as shown in the following scenario:

1. Execute:

       pod

1. Look through the output (note the displayed `API version` and `resource type` [optional] and the new `INDEX` column):

       v1/pods:

       INDEX   NAME                                        READY   STATUS      RESTARTS   AGE
       1       my-stateful-set-sandbox-0                   1/1     Running     0          94d
       2       my-scheduled-job-sandbox-1715615200-c64dc   0/1     Completed   0          2d6h
       3       my-scheduled-job-sandbox-1715701600-jdfv7   0/1     Completed   0          30h
       4       my-scheduled-job-sandbox-1715788000-fswjd   0/1     Completed   0          6h46m
       5       demo-java-app-sandbox-6755c8dfd7-8wkx2      1/1     Running     0          4h11m
       6       demo-java-app-sandbox-6755c8dfd7-dxw76      1/1     Running     0          4h11m
       7       demo-nodejs-app-sandbox-d45f7b8b-8bhwm      2/2     Running     0          5d2h
       8       demo-nodejs-app-sandbox-d45f7b8b-c4vjz      2/2     Running     0          5d2h
       9       traefik-sandbox-7c5f6de147-5q24z            1/1     Running     0          61d
       10      traefik-sandbox-7c5f6de147-3s2k8            1/1     Running     0          61d

1. Get the YAML configuration of the resource, by its row `INDEX`:

       pod 5

1. Describe the details of the resource, by specifying its row `INDEX` and adding the `d` parameter:

       pod 5 d

1. Follow the logs of the resource, by specifying its row `INDEX`:

       kl 5

1. Execute a command on the resource, by specifying its row `INDEX` and the command to run (e.g. `env`):

       kx 5 env

The default script configuration enables `get` and `describe` querying for all Kubernetes resource types that support
those actions (both "cluster-wide" and "namespaced" resources). Querying for `logs` and running `exec` commands can only
be performed on Pods.

The script can be updated to [include/exclude any Kubernetes resources](#included-resources) desired, and the
[names of the generated functions can be customized](#function-names) as needed.

## Setup

### Requirements

1. `zsh` - This tool has been written to work with ZSH. The main non-Bash-compatible construct used is ZSH's specific
   method for accessing the keys of an associative array: `${(k)associative_array}`. Bash uses the following method for
   accessing the keys of an associative array: `${!associative_array[@]}`. Modifying the script with the Bash-specific
   method for accessing associative array keys would probably make this generator script Bash-compatible, but hasn't
   been tested.

1. `kubectl` - A [command-line tool maintained by the Cloud Native Computing Foundation][kubectl] for running commands
   against Kubernetes clusters. All queries executed by this tool use `kubectl` to interact with a cluster.

1. As a result of the way this tool's generated functions handle passed parameters, it is not possible to specify the
   namespace for a query via the `--namespace` flag. Rather, the namespace must be set in the configuration file of the
   current context. This can be accomplished easily and dynamically by using a tool like [`kubens`][kubens].

### Optional

1. `aws-vault` - A [command-line tool from 99designs][aws-vault] for securely storing and accessing AWS IAM credentials
   in your operating system's secure keystore and then generating temporary credentials from those to expose to your
   shell and applications. If using `aws-vault`, the environment variable `$AWS_PROFILE` must be set for named profile
   selection, as described in the [AWS CLI Named Profiles documentation][aws-cli-named-profiles].

   Using `aws-vault` requires setting the environment variable feature flag `K8S_FF_USE_AWS_VAULT=true` (defaults to
   `false`). Doing so will replace all of the tool's invocations of `kubectl` with
   `aws-vault exec $AWS_PROFILE -- kubectl`. The full set of configurable options are provided in the
   [feature flags section](#feature-flags) below.

### Installation

üí•**WARNING**üí•This script generates A LOT of new shell functions. There is a chance that some of the function names
may conflict with the names of existing functions, aliases, binaries, etc. There is no built-in process for verifying
that a function name is currently unused before attempting to create it. Please check that the names of the functions
that will be created are not already in use. If there would be a collision in name usage, change the shortname (map key)
for any conflicting names before sourcing this script. Failure to do so may result in unexpected behavior üî•

TODO

## Functions

- [Dynamically-generated functions](#dynamically-generated-functions)
- [help](#help(1))
- [kl](#kl\(1\))
- [kx](#kx)

### Dynamically-generated functions

This tool dynamically generates functions from a collection of available Kubernetes resource types, which are defined as
values in the map (technically, the "associative array") `resource_map_all`. The result is a collection of
directly-callable ZSH functions, whose names are derived from the map's keys. The map's keys (and therefore, the
generated function names) are the shortnames of the resource types they map to, e.g.

    ["pvc"]="persistentvolumeclaims"

Each generated function has the same body; the only difference is the name of the function itself:

    pvc () {
     function_name=$0
     resource_type=${resource_map_all[$function_name]}
     passed_param1=$1
     passed_param2=$2
     _k8s_resource_query $function_name $resource_type $passed_param1 $passed_param2
    }

    svc () {
     function_name=$0
     resource_type=${resource_map_all[$function_name]}
     passed_param1=$1
     passed_param2=$2
     _k8s_resource_query $function_name $resource_type $passed_param1 $passed_param2
    }

When a function is executed, the function's name is used as the key in a map lookup, to identify the full name of the
associated Kubernetes resource type. The shortname, resource type name, and any passed parameters, are then passed to
a generic Kubernetes resource query function.


<!-- ## DESCRIPTION: Dymanically generates functions from the available K8s resource types defined in the array 'resource_map'
## The result of this loop is a number of directly-callable functions, with names derived from the 'resource_map' keys
## The name of each generated function is pulled from the keys of the 'resource_map' array; shorthand names are used
## The '$0' in the 'resource_map[$0]' lookup is the name of the current function, which returns a full resource type name
##
## USAGE 1: <k8s_resource_type>
## EXAMPLE 1: pod
## OUTPUT 1: A multi-line list of resources of the specified type, with a leading index number per line
##
## USAGE 2: <k8s_resource_type> <resource_output_type>
## EXAMPLE 2: pod wide
## OUTPUT 2: A multi-line list of resources of the specified type, with a leading index number per line and wide output
##
## USAGE 3: <k8s_resource_type> <resource_list_index>
## EXAMPLE 3: pod 5
## OUTPUT 3: The YAML specification of the resource identified by the provided line index
##
## USAGE 4: <k8s_resource_type> <resource_list_index> <description indicator 'd'>
## EXAMPLE 4: pod 5 d
## OUTPUT 4: The full description of the resource identified by the provided line index
## -->


### help(1)

Prints a sorted list of `<command> -> <resource_type>` mappings, to show all available dynamic functions defined by this
tool. The output is derived directly from the maps (associative arrays) that define the function-to-resource mappings.
For additional context and clarity, the output is split into separate list of "cluster-wide" and "namespaced" functions.
Functions from both lists are execute in the same way. However, functions in the "namespaced" list require that a
namespace is specified somewhere (preferably in the current Kubernetes context), whereas the "cluster-wide" do not rely
on any namespace value having been set.

Example:

1. Execute:
       help
1. View the output as a reminder of the available functions (truncated output shown for brevity):
       Cluster-wide K8s resource functions:
         apis -> apiservices
         cr -> clusterroles
         crb -> clusterrolebindings
         ...
         sc -> storageclasses
         va -> volumeattachments
         vwh -> validatingwebhookconfigurations

       Namespaced K8s resource functions:
         am -> alertmanagers
         cj -> cronjobs
         cm -> configmaps
         ...
         tlss -> tlsstores
         ts -> traefikservices
         vlt -> vaults

### kl(1)

Displays logs for a given Kubernetes Pod, selected by `INDEX` number from the output of the `pod` command. A container
name may be passed as a parameter, if the Pod includes multiple containers.

Example:

1. Execute:
       pod
1. Visually look through the output:
       v1/pods:

       INDEX   NAME                                        READY   STATUS      RESTARTS   AGE
       1       demo-java-app-sandbox-6755c8dfd7-8wkx2      1/1     Running     0          4h11m
       2       demo-java-app-sandbox-6755c8dfd7-dxw76      1/1     Running     0          4h11m
       3       demo-nodejs-app-sandbox-d45f7b8b-8bhwm      2/2     Running     0          5d2h
       4       demo-nodejs-app-sandbox-d45f7b8b-c4vjz      2/2     Running     0          5d2h
1. If the Pod includes only one container (e.g. the Pod with `INDEX 1`), follow the logs for that container:
       kl 1
1. If the Pod includes multiple containers (e.g. the Pod with `INDEX 3`), an error is thrown if a container name is not
   specified as a parameter:
       kl 3
       Error from server (BadRequest): a container name must be specified for pod demo-nodejs-app-sandbox-d45f7b8b-8bhwm, choose one of: [consul-template alpine demo-app] or one of the init containers: [vault-agent copy-vault-env init-ubuntu]
1. When one of the available container names is provided, the proper container logs are displayed:
       kl 3 consul-template
       kl 3 demo-app

### kx(1)

TODO

## Customization

### Included resources

TODO

### Function names

TODO

### Feature flags

The following environment variables can be used as flags to enable or disable functionality within the tool.

| Environment variable          | Description                                                                                                                                                          | Default value |
| ----------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------- |
| `K8S_FF_PIPE_DETAILS_TO_LESS` | Controls whether or not to pipe `kubectl`'s `get` and `describe` output to `less`                                                                                    | true          |
| `K8S_FF_SHOW_RESOURCE_TYPE`   | Controls whether or not the resource API version and type are displayed with each query                                                                              | true          |
| `K8S_FF_USE_AWS_VAULT`        | Controls whether or not to use `aws-vault`. If `true`, Kubernetes queries use `aws-vault exec $AWS_PROFILE -- kubectl`; if `false`, Kubernetes queries use `kubectl` | false         |

[aws-vault]: https://github.com/99designs/aws-vault
[aws-cli-named-profiles]: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html
[kubectl]: https://kubernetes.io/docs/tasks/tools/#kubectl
[kubens]: https://github.com/ahmetb/kubectx/blob/master/kubens
